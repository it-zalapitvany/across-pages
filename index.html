<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">

  <title>VR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #blackout {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      opacity: 0;
      z-index: 9;
      pointer-events: none;
      transition: opacity 1s ease-in-out;
    }
  </style>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
        .catch(console.error);
    });
  }
</script>
</head>

<body>
  <div id="blackout"></div>

  <a-scene id="a-scene" xr-mode-ui="enabled: true"
    webxr="optionalFeatures: local-floor, bounded-floor; requiredFeatures: local-floor">
    <a-assets>
      <img id="scene1" src="scene1.jpg" crossorigin="anonymous">
      <img id="scene2" src="scene2.jpg" crossorigin="anonymous">
      <audio id="voice1" src="voice1.mp3" preload="auto"></audio>
      <audio id="voice2" src="voice2.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Skies -->
    <a-sky id="sky" src="#scene1" rotation="0 -90 0" visible="false"></a-sky>
    <a-sky id="lobbySky" color="#000000" visible="true"></a-sky>

    <!-- Camera + cursor for VR controller -->
    <a-entity id="cameraRig">
      <a-entity camera look-controls position="0 1.6 0">
        <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
      </a-entity>
      <a-entity laser-controls="hand: right"></a-entity>
    </a-entity>

    <!-- 3D Start button in front of camera -->
    <a-entity id="vrStartBtn" class="clickable" geometry="primitive: plane; width: 1; height: 0.3"
      material="color: #007bff" position="0 1.2 -2" text="value: Start Experience; color: white; align: center">
    </a-entity>
  </a-scene>

  <script>
    const skyEl = document.getElementById("sky");
    const lobbySky = document.getElementById("lobbySky");
    const vrStartBtn = document.getElementById("vrStartBtn");
    const cursor = document.getElementById("cursor");
    const blackout = document.getElementById("blackout");
    const voice1 = document.getElementById("voice1");
    const voice2 = document.getElementById("voice2");

    function fadeToBlack(callback) {
      blackout.style.opacity = 1;
      setTimeout(() => {
        callback();
        blackout.style.opacity = 0;
      }, 1000);
    }

    function resetExperience() {
      // Show lobby sky and button
      skyEl.setAttribute("visible", "false");
      lobbySky.setAttribute("visible", "true");
      vrStartBtn.setAttribute("visible", "true");
      vrStartBtn.classList.add("clickable");
      voice1.currentTime = 0;
      voice2.currentTime = 0;
    }

    function playExperience() {

      vrStartBtn.setAttribute("visible", "false");
      vrStartBtn.classList.remove("clickable");

      fadeToBlack(() => {
        lobbySky.setAttribute("visible", "false");
        skyEl.setAttribute("visible", "true");
        skyEl.setAttribute("src", "#scene1");
        skyEl.setAttribute("rotation", "0 -90 0");
        voice1.play();
      });

      voice1.onended = () => {
        setTimeout(() => {
          fadeToBlack(() => {
            skyEl.setAttribute("src", "#scene2");
            skyEl.setAttribute("rotation", "0 -90 0");
            voice2.play();
          });
        }, 1000);
      };

      voice2.onended = () => {
        setTimeout(() => {
          fadeToBlack(() => {
            resetExperience();
            console.log("Returned to lobby in VR");
          });
        }, 1000);
      };
    }

    // Click listener for 3D button
    vrStartBtn.addEventListener("click", playExperience);
  </script>
</body>

</html>