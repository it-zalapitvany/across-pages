<!-- remove your extra button; VRButton supplies the user gesture -->
<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quest WebXR sanity</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden}
  #log{position:fixed;left:0;bottom:0;max-height:40vh;overflow:auto;
       font:12px/1.4 monospace;background:rgba(0,0,0,.7);color:#0f0;padding:.5rem}
</style>
<div id="log"></div>
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { VRButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/VRButton.js';

const logEl = document.getElementById('log');
const log = (...a)=>{ console.log(...a); logEl.textContent += a.join(' ')+'\n'; };

if (!('xr' in navigator)) {
  log('navigator.xr not found'); throw new Error('No WebXR');
}

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: 'high-performance' });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
renderer.xr.setReferenceSpaceType('local-floor'); // prefer floor-aligned
document.body.appendChild(renderer.domElement);

// IMPORTANT on some Quest browser builds: ensure XR-compatible GL
const gl = renderer.getContext();
if (gl && gl.makeXRCompatible) {
  try { await gl.makeXRCompatible(); log('makeXRCompatible OK'); }
  catch (e) { log('makeXRCompatible FAILED:', e); }
}

// Robust event logging
renderer.xr.addEventListener('sessionstart', ()=>log('sessionstart'));
renderer.xr.addEventListener('sessionend', ()=>log('sessionend'));
renderer.domElement.addEventListener('webglcontextlost', (e)=>{ e.preventDefault(); log('webglcontextlost'); });
document.addEventListener('visibilitychange', ()=>log('visibility:', document.visibilityState));

document.body.appendChild(VRButton.createButton(renderer)); // use this to enter VR

// Scene
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);
const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);

const geo = new THREE.BoxGeometry(0.4, 0.4, 0.4);
const mat = new THREE.MeshStandardMaterial();
const mesh = new THREE.Mesh(geo, mat);
mesh.position.z = -2;
scene.add(mesh);

const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(1, 1, 1);
scene.add(light);

// Use setAnimationLoop (submits frames in XR)
renderer.setAnimationLoop((t) => {
  mesh.rotation.y += 0.01;
  renderer.render(scene, camera);
});

// Handle resize
addEventListener('resize', () => {
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
});
</script>
</html>
