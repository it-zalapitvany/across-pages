<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>VR Experience</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #blackout {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      opacity: 0;
      z-index: 9;
      pointer-events: none;
      transition: opacity 1s ease-in-out;
    }
  </style>
</head>

<body>
  <div id="blackout"></div>

  <a-scene id="a-scene" xr-mode-ui="enabled: true">
    <a-assets>
      <img id="scene1" src="scene1.jpg" crossorigin="anonymous">
      <img id="scene2" src="scene2.jpg" crossorigin="anonymous">
      <audio id="voice1" src="voice1.mp3" preload="auto"></audio>
      <audio id="voice2" src="voice2.mp3" preload="auto"></audio>
    </a-assets>

    <!-- Skies -->
    <a-sky id="sky" src="#scene1" rotation="0 -90 0" visible="false"></a-sky>
    <a-sky id="lobbySky" color="#000000" visible="true"></a-sky>

    <!-- Camera + cursor for VR controller -->
    <a-entity id="cameraRig">
      <a-entity camera look-controls position="0 1.6 0">
        <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
      </a-entity>
      <a-entity laser-controls="hand: right"></a-entity>
    </a-entity>

    <!-- 3D Start button in front of camera -->
    <a-entity id="vrStartBtn" class="clickable" geometry="primitive: plane; width: 1; height: 0.3"
      material="color: #007bff" position="0 1.2 -2" text="value: Start Experience; color: white; align: center">
    </a-entity>
  </a-scene>

  <script>
  const sceneEl   = document.getElementById("a-scene");
  const skyEl     = document.getElementById("sky");
  const lobbySky  = document.getElementById("lobbySky");
  const vrStartBtn= document.getElementById("vrStartBtn");
  const blackout  = document.getElementById("blackout");
  const voice1    = document.getElementById("voice1");
  const voice2    = document.getElementById("voice2");

  // Optional: log support on Quest
  (async () => {
    console.log('navigator.xr =', !!navigator.xr);
    if (navigator.xr?.isSessionSupported) {
      console.log('immersive-vr supported =',
        await navigator.xr.isSessionSupported('immersive-vr'));
    }
  })();

  function fadeToBlack(callback) {
    blackout.style.opacity = 1;
    setTimeout(() => { callback(); blackout.style.opacity = 0; }, 1000);
  }

  function resetExperience() {
    skyEl.setAttribute("visible", "false");
    lobbySky.setAttribute("visible", "true");
    vrStartBtn.setAttribute("visible", "true");
    vrStartBtn.classList.add("clickable");
    voice1.currentTime = 0; voice2.currentTime = 0;
  }

  function startExperienceAfterEnterVR() {
    // we are in immersive now â€” run your flow
    vrStartBtn.setAttribute("visible", "false");
    vrStartBtn.classList.remove("clickable");

    fadeToBlack(() => {
      lobbySky.setAttribute("visible", "false");
      skyEl.setAttribute("visible", "true");
      skyEl.setAttribute("src", "#scene1");
      skyEl.setAttribute("rotation", "0 -90 0");
      voice1.play();
    });

    voice1.onended = () => {
      setTimeout(() => {
        fadeToBlack(() => {
          skyEl.setAttribute("src", "#scene2");
          skyEl.setAttribute("rotation", "0 -90 0");
          voice2.play();
        });
      }, 1000);
    };

    voice2.onended = () => {
      setTimeout(() => {
        fadeToBlack(() => {
          resetExperience();
          console.log("Returned to lobby in VR");
        });
      }, 1000);
    };
  }

  // 1) Use the Start button as the user gesture to enter XR
  vrStartBtn.addEventListener("click", async () => {
    try {
      // Some browsers still need a gesture to start audio; this click counts.
      // Enter immersive VR first:
      await sceneEl.enterVR(); // If this resolves, we left the panel.
      // Either wait for the event, or continue right away:
      // startExperienceAfterEnterVR();
    } catch (e) {
      console.warn("enterVR() failed:", e);
      // Fallback: run in magic-window mode
      startExperienceAfterEnterVR();
    }
  });

  // 2) When we actually enter VR, then begin the content
  sceneEl.addEventListener('enter-vr', () => {
    console.log('Entered immersive VR');
    startExperienceAfterEnterVR();
  });

  // (Optional) Handle exit back to panel
  sceneEl.addEventListener('exit-vr', () => {
    console.log('Exited VR');
    resetExperience();
  });
</script>

</body>

</html>